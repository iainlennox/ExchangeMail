@{
    ViewData["Title"] = "Import Progress";
}

<div class="container mt-4">
    <div class="card">
        <div class="card-header">
            <h2>Importing Messages...</h2>
        </div>
        <div class="card-body">
            <div class="progress mb-3">
                <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar"
                    style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
            </div>

            <p id="statusText">Preparing import...</p>
            <p>Processed: <span id="processedCount">0</span> / <span id="totalCount">...</span></p>

            <div id="completionArea" style="display:none;">
                <a asp-action="Index" class="btn btn-success">Return to Mailbox</a>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script>
    const jobId = '@ViewBag.JobId';
    const statusUrl = '@Url.Action("GetImportStatus", "Mail")?jobId=' + jobId;

    function checkStatus() {
        fetch(statusUrl)
            .then(response => response.json())
            .then(data => {
                const percent = data.percentComplete;
                const progressBar = document.getElementById('progressBar');
                const statusText = document.getElementById('statusText');
                const processedCount = document.getElementById('processedCount');
                const totalCount = document.getElementById('totalCount');

                progressBar.style.width = percent + '%';
                progressBar.innerText = percent + '%';
                progressBar.setAttribute('aria-valuenow', percent);

                processedCount.innerText = data.processedItems;
                totalCount.innerText = data.totalItems;

                if (data.status === 'Completed') {
                    statusText.innerText = 'Import Completed Successfully!';
                    progressBar.classList.remove('progress-bar-animated');
                    progressBar.classList.add('bg-success');
                    document.getElementById('completionArea').style.display = 'block';
                } else if (data.status === 'Failed') {
                    statusText.innerText = 'Import Failed: ' + data.error;
                    progressBar.classList.remove('progress-bar-animated');
                    progressBar.classList.add('bg-danger');
                } else {
                    statusText.innerText = 'Importing...';
                    setTimeout(checkStatus, 1000);
                }
            })
            .catch(error => {
                console.error('Error fetching status:', error);
                setTimeout(checkStatus, 2000);
            });
    }

    document.addEventListener('DOMContentLoaded', checkStatus);
</script>
}
