@using MimeKit
@model IEnumerable<MimeMessage>

<div class="d-flex flex-column h-100">
    <style>
        @@media (max-width: 768px) {
            .mail-list-item {
                padding: 1rem !important;
            }
            .mail-list-item .sender {
                font-size: 1rem !important;
                margin-bottom: 0.25rem;
            }
            .mail-list-item .subject {
                font-size: 1.1rem !important;
                font-weight: 600;
                margin-bottom: 0.25rem;
            }
            .mail-list-item .preview {
                font-size: 0.95rem !important;
                white-space: normal; /* Allow wrapping */
                display: -webkit-box;
                -webkit-line-clamp: 2; /* Show 2 lines */
                -webkit-box-orient: vertical;
                overflow: hidden;
            }
        }
    </style>
    <div class="p-2 border-bottom d-flex gap-2">
        <form id="searchForm" class="input-group input-group-sm flex-grow-1">
            <span class="input-group-text bg-transparent border-end-0"><i class="bi bi-search"></i></span>
            <input type="text" class="form-control border-start-0" placeholder="Search" name="searchString"
                value="@ViewBag.SearchString">
        </form>
        <button class="btn btn-sm btn-outline-secondary" onclick="markAllAsRead()" title="Mark all as read">
            <i class="bi bi-envelope-open"></i>
        </button>
    </div>

    <div class="flex-grow-1 overflow-auto" id="messageListContainer">
        @if (!Model.Any())
        {
            <div class="text-center p-4 text-muted">
                <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                No messages found.
            </div>
        }
        else
        {
            @foreach (var message in Model)
            {
                var isRead = message.Headers.Contains("X-Is-Read");
                var dbId = message.Headers["X-Db-Id"] ?? message.MessageId;
                var isUrgent = (message.Headers["X-Labels"] ?? "").Contains("Urgent", StringComparison.OrdinalIgnoreCase);

                var threadId = message.Headers["X-Thread-Id"];
                var threadCountVal = message.Headers["X-Thread-Count"];
                int.TryParse(threadCountVal, out int threadCount);
                if (threadCount < 2) threadCount = 0; // Treat single as non-thread

                <div class="thread-wrapper">
                    <div class="mail-list-item @(isRead ? "" : "unread")" data-id="@dbId" data-focused="@message.Headers["X-Is-Focused"]" draggable="true"
                ondragstart="drag(event)" onclick="loadMessage('@dbId', this)">
                        <div class="d-flex justify-content-between align-items-baseline">
                            <span class="sender text-truncate" style="max-width: 70%;">
                                @if (isUrgent)
                                {
                                    <i class="bi bi-exclamation-circle-fill text-danger me-1" title="High Priority"></i>
                                }
                                @if (threadCount > 1)
                                {
                                    <span class="badge bg-secondary rounded-pill me-1" style="font-size: 0.7em;">@threadCount</span>
                                    <i class="bi bi-chevron-right me-1 text-muted thread-expander"
                            data-thread-id="@threadId" id="icon-@threadId" style="cursor: pointer;"></i>
                                }
                                @message.From
                            </span>
                            <span class="date">@message.Date.ToString("MMM d")</span>
                        </div>
                        <div class="subject text-truncate">@message.Subject</div>
                        <div class="preview">
                            @(message.TextBody?.Substring(0, Math.Min(message.TextBody.Length, 50)) ?? "No preview available")
                        </div>
                    </div>
                    @if (threadCount > 1)
                    {
                        <div id="thread-@threadId" class="thread-messages collapse ps-2 border-start ms-2 my-1"></div>
                    }
                </div>
            }
        }
    </div>

    <div class="p-2 border-top d-flex justify-content-between align-items-center border-secondary">
        @if (ViewBag.Page > 1)
        {
            <a href="@Url.Action("Index", new { page = ViewBag.Page - 1, folder = ViewBag.Folder, searchString = ViewBag.SearchString, focused = ViewBag.Focused })"
            class="btn btn-sm btn-outline-secondary">
                <i class="bi bi-chevron-left"></i>
            </a>
        }
        else
        {
            <span class="btn btn-sm btn-outline-secondary disabled"><i class="bi bi-chevron-left"></i></span>
        }

        <span class="small text-muted">Page @ViewBag.Page of @ViewBag.TotalPages</span>

        @if (ViewBag.Page < ViewBag.TotalPages)
        {
            <a href="@Url.Action("Index", new { page = ViewBag.Page + 1, folder = ViewBag.Folder, searchString = ViewBag.SearchString, focused = ViewBag.Focused })"
            class="btn btn-sm btn-outline-secondary">
                <i class="bi bi-chevron-right"></i>
            </a>
        }
        else
        {
            <span class="btn btn-sm btn-outline-secondary disabled"><i class="bi bi-chevron-right"></i></span>
        }
    </div>
</div>
