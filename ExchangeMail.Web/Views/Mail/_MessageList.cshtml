@using MimeKit
@model IEnumerable<MimeMessage>

<div class="d-flex flex-column h-100">
    <div class="p-2 border-bottom d-flex gap-2">
        <form id="searchForm" class="input-group input-group-sm flex-grow-1">
            <span class="input-group-text bg-transparent border-end-0"><i class="bi bi-search"></i></span>
            <input type="text" class="form-control border-start-0" placeholder="Search" name="searchString"
                value="@ViewBag.SearchString">
        </form>
        <button class="btn btn-sm btn-outline-secondary" onclick="markAllAsRead()" title="Mark all as read">
            <i class="bi bi-envelope-open"></i>
        </button>
    </div>

    <div class="flex-grow-1 overflow-auto" id="messageListContainer">
        @if (!Model.Any())
        {
            <div class="text-center p-4 text-muted">
                <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                No messages found.
            </div>
        }
        else
        {
            @foreach (var message in Model)
            {
                var isRead = message.Headers.Contains("X-Is-Read");
                var dbId = message.Headers["X-Db-Id"] ?? message.MessageId;
                <div class="mail-list-item @(isRead ? "" : "unread")" data-id="@dbId" draggable="true" ondragstart="drag(event)"
            onclick="loadMessage('@dbId', this)">
                    <div class="d-flex justify-content-between align-items-baseline">
                        <span class="sender text-truncate" style="max-width: 70%;">@message.From</span>
                        <span class="date">@message.Date.ToString("MMM d")</span>
                    </div>
                    <div class="subject text-truncate">@message.Subject</div>
                    <div class="preview">
                        @(message.TextBody?.Substring(0, Math.Min(message.TextBody.Length, 50)) ?? "No preview available")
                    </div>
                </div>
            }
        }
    </div>

    <div class="p-2 border-top d-flex justify-content-between align-items-center border-secondary">
        @if (ViewBag.Page > 1)
        {
            <a href="@Url.Action("Index", new { page = ViewBag.Page - 1, folder = ViewBag.Folder, searchString = ViewBag.SearchString })"
            class="btn btn-sm btn-outline-secondary">
                <i class="bi bi-chevron-left"></i>
            </a>
        }
        else
        {
            <span class="btn btn-sm btn-outline-secondary disabled"><i class="bi bi-chevron-left"></i></span>
        }

        <span class="small text-muted">Page @ViewBag.Page of @ViewBag.TotalPages</span>

        @if (ViewBag.Page < ViewBag.TotalPages)
        {
            <a href="@Url.Action("Index", new { page = ViewBag.Page + 1, folder = ViewBag.Folder, searchString = ViewBag.SearchString })"
            class="btn btn-sm btn-outline-secondary">
                <i class="bi bi-chevron-right"></i>
            </a>
        }
        else
        {
            <span class="btn btn-sm btn-outline-secondary disabled"><i class="bi bi-chevron-right"></i></span>
        }
    </div>
</div>
